# Система регистрации горных перевалов

REST API для мобильного приложения туристов, которое позволяет регистрировать информацию о горных перевалах и отправлять её в систему ФСТР (Федерация спортивного туризма России) для модерации.

## Описание задачи

Проект разработан в рамках стажировки для создания REST API, который позволяет:

- Туристам добавлять информацию о новых горных перевалах
- Модераторам ФСТР обрабатывать поступающие заявки
- Пользователям просматривать статусы своих заявок и редактировать данные в определенных случаях

### Основная цель
Создать удобный интерфейс для сбора информации о горных перевалах от туристского сообщества и передачи этих данных в федеральную систему.

### Реализованная функциональность

**Спринт 1:**
- Создание моделей данных для пользователей, координат, уровней сложности, перевалов и изображений
- Базовый REST API метод POST /submitData/ для добавления новых перевалов
- Класс PassDataHandler для работы с базой данных
- Настройка PostgreSQL и переменных окружения
- Контейнеризация через Docker

**Спринт 2:**
- GET /submitData/<id>/ - получение информации о перевале по ID
- PATCH /submitData/<id>/ - редактирование перевала (только со статусом "new")
- GET /submitData/?user__email=<email> - получение всех перевалов пользователя
- Защита от изменения персональных данных пользователя при редактировании
- Система статусов модерации (new/pending/accepted/rejected)

**Спринт 3:**
- Подробная документация API
- Примеры использования всех методов
- Описание структуры данных и ответов

## Техническое описание

- **Framework:** Django 4.2.7
- **Database:** PostgreSQL 15
- **API:** Django REST Framework 3.14.0
- **Контейнеризация:** Docker + Docker Compose
- **Архитектура:** REST API

## Запуск проекта

### Через Docker (рекомендуемый способ)

1. Убедитесь, что Docker и Docker Compose установлены
2. Клонируйте проект:
```bash
git clone https://github.com/Kanny-Dzmitry/pereval-online-stazhirovka.git
cd pereval-online-stazhirovka
```

3. Запустите проект:
```bash
docker-compose up --build
```

Проект будет доступен по адресу: `http://localhost:8000`

**Swagger документация будет доступна по адресам:**
- Swagger UI: `http://localhost:8000/swagger/`
- ReDoc: `http://localhost:8000/redoc/`
- API Schema: `http://localhost:8000/swagger.json`

### Ручной запуск (для разработки)

1. Установите зависимости:
```bash
pip install -r requirements.txt
```

2. Настройте переменные окружения (создайте файл `.env`):
```
FSTR_DB_HOST=localhost
FSTR_DB_PORT=5432
FSTR_DB_LOGIN=fstr_user
FSTR_DB_PASS=fstr_password
FSTR_DB_NAME=fstr_db
SECRET_KEY=your-secret-key
DEBUG=True
```

3. Запустите PostgreSQL и создайте базу данных `fstr_db`

4. Примените миграции:
```bash
python manage.py makemigrations
python manage.py migrate
```

5. Создайте суперпользователя (опционально):
```bash
python manage.py createsuperuser
```

6. Запустите сервер:
```bash
python manage.py runserver
```

## API Documentation

### Обзор методов

| Метод | URL | Описание |
|-------|-----|----------|
| POST | /submitData/ | Создание нового перевала |
| GET | /submitData/<id>/ | Получение информации о перевале |
| PATCH | /submitData/<id>/ | Редактирование перевала |
| GET | /submitData/?user__email=<email> | Список перевалов пользователя |

### 1. POST /submitData/

Создание новой записи о перевале.

**Функциональность:**
- Принимает JSON с данными о перевале
- Автоматически устанавливает статус "new"
- Создает связанные записи (пользователь, координаты, уровни сложности)
- Обрабатывает загружаемые изображения

**Структура запроса:**
```json
{
  "beauty_title": "пер. ",
  "title": "Пхия",
  "other_titles": "Триев", 
  "connect": "соединяет долины А и Б",
  "user": {
    "email": "qwerty@mail.ru",
    "fam": "Пупкин", 
    "name": "Василий",
    "otc": "Иванович",
    "phone": "+7 555 55 55"
  },
  "coords": {
    "latitude": "45.3842",
    "longitude": "7.1525", 
    "height": "1200"
  },
  "level": {
    "winter": "",
    "summer": "1А", 
    "autumn": "1А",
    "spring": ""
  },
  "images": [
    {"data": "<base64_данные>", "title": "Седловина"}, 
    {"data": "<base64_данные>", "title": "Подъём"}
  ]
}
```

**Структура ответа:**
```json
{
  "status": 200,
  "message": null,
  "id": 42
}
```

**Возможные ошибки:**
- **400** - Bad Request (недостаточно полей или неверные данные)
- **500** - ошибка сервера/БД

### 2. GET /submitData/<id>/

Получение полной информации о перевале по его ID.

**Функциональность:**
- Возвращает все данные о перевале включая статус модерации
- Показывает информацию о пользователе, координатах, уровнях сложности
- Включает список связанных изображений

**Пример ответа:**
```json
{
  "beauty_title": "пер. ",
  "title": "Пхия",
  "other_titles": "Триев",
  "connect": "соединяет долины А и Б",
  "add_time": "2024-01-01T12:00:00Z",
  "status": "new",
  "user": {
    "email": "qwerty@mail.ru",
    "fam": "Пупкин",
    "name": "Василий",
    "otc": "Иванович",
    "phone": "+7 555 55 55"
  },
  "coords": {
    "latitude": "45.3842",
    "longitude": "7.1525",
    "height": "1200"
  },
  "level": {
    "winter": "",
    "summer": "1А",
    "autumn": "1А", 
    "spring": ""
  },
  "images": [...]
}
```

**Возможные ошибки:**
- **404** - перевал с указанным ID не найден

### 3. PATCH /submitData/<id>/

Редактирование существующего перевала.

**Ограничения:**
- Можно редактировать только записи со статусом "new"
- ЗАПРЕЩЕНО изменять персональные данные пользователя (ФИО, email, телефон)
- Можно изменять только данные о самом перевале

**Разрешенные для изменения поля:**
- beauty_title, title, other_titles, connect
- coords (latitude, longitude, height)
- level (winter, summer, autumn, spring)
- images

**Пример запроса:**
```json
{
  "title": "Новое название перевала",
  "coords": {
    "latitude": "45.9999",
    "longitude": "7.9999",
    "height": "1500"
  },
  "level": {
    "summer": "1Б"
  }
}
```

**Успешный ответ:**
```json
{
  "state": 1,
  "message": null
}
```

**Ошибки редактирования:**
```json
{
  "state": 0,
  "message": "Редактирование невозможно. Статус записи: accepted. Можно редактировать только записи со статусом \"new\"."
}
```

### 4. GET /submitData/?user__email=<email>

Получение всех перевалов, отправленных пользователем с указанным email.

**Функциональность:**
- Возвращает список всех перевалов пользователя
- Сортировка по дате добавления (новые первые)
- Показывает текущие статусы модерации

**Пример запроса:**
```
GET /submitData/?user__email=qwerty@mail.ru
```

**Пример ответа:**
```json
[
  {
    "beauty_title": "пер. ",
    "title": "Пхия",
    "status": "new",
    "add_time": "2024-01-01T12:00:00Z",
    "user": {...},
    "coords": {...},
    "level": {...},
    "images": [...]
  },
  {
    "beauty_title": "пер. ",
    "title": "Другой перевал",
    "status": "accepted", 
    "add_time": "2024-01-02T15:30:00Z",
    "user": {...},
    "coords": {...},
    "level": {...},
    "images": [...]
  }
]
```

**Возможные ситуации:**
- Пустой массив `[]` если у пользователя нет перевалов
- **400** - если параметр user__email не указан

## Тестирование API

Проект включает готовые тестовые скрипты для проверки функциональности:

### Базовое тестирование
```bash
python test_api.py
```

**Что тестируется:**
- Создание нового перевала (POST /submitData/)
- Обработка ошибок при недостающих полях
- Корректность структуры ответов

### Расширенное тестирование
```bash
python test_new_api.py
```

**Что тестируется:**
- Все методы API (POST, GET, PATCH)
- Получение перевала по ID
- Фильтрация по email пользователя
- Редактирование перевалов
- Блокировка изменения запрещенных полей
- Проверка статусов модерации

**Примеры тестовых данных:**
- Создание тестового перевала
- Попытка редактирования с разными статусами
- Проверка защиты персональных данных

Убедитесь, что сервер запущен на `localhost:8000` перед запуском тестов.

## Swagger/OpenAPI документация

Проект включает автоматически генерируемую интерактивную документацию API с помощью Swagger/OpenAPI.

### Доступные интерфейсы

**Swagger UI** - `http://localhost:8000/swagger/`
- Интерактивная документация с возможностью тестирования API
- Просмотр схем данных и примеров запросов/ответов
- Возможность выполнения запросов прямо из браузера

**ReDoc** - `http://localhost:8000/redoc/`
- Альтернативный интерфейс документации
- Более читабельное представление документации
- Удобная навигация по методам

**OpenAPI Schema** - `http://localhost:8000/swagger.json`
- Полная спецификация API в формате JSON
- Может использоваться для генерации клиентского кода
- Соответствует стандарту OpenAPI 3.0

### Возможности Swagger UI

- Просмотр всех доступных endpoint'ов
- Детальное описание параметров запросов
- Примеры ответов для всех HTTP статус кодов
- Интерактивное тестирование API методов
- Валидация данных на стороне клиента
- Экспорт спецификации в различных форматах

### Автоматическая документация

Документация автоматически обновляется при изменении:
- Моделей данных (через сериализаторы)
- Описаний методов в views
- Валидационных правил
- Примеров ответов

## База данных

### Архитектура данных

Система использует реляционную модель с четко разделенными сущностями:

**User** - пользователи системы
- email (уникальный), fam, name, otc, phone
- Один пользователь может создать множество перевалов

**Coords** - географические координаты  
- latitude (широта), longitude (долгота), height (высота)
- Связь один к одному с перевалом

**Level** - уровни сложности прохождения
- winter, summer, autumn, spring (сезонные оценки сложности)
- Связь один к одному с перевалом

**Pass** - основная сущность (перевал)
- beauty_title, title, other_titles, connect
- status (статус модерации), add_time (время создания)
- Связи с User, Coords, Level

**Image** - фотографии перевала
- data (файл изображения), title (описание)
- Множественная связь с Pass (один перевал - много фото)

### Статусы модерации

Система поддерживает следующий жизненный цикл записи:

- **new** - новая запись, ожидает модерации (можно редактировать)
- **pending** - взята в работу модератором (редактирование заблокировано)  
- **accepted** - модерация пройдена успешно (архивная запись)
- **rejected** - модерация не пройдена (требуется доработка)

### Диаграмма связей

```
User (1) -----> (M) Pass (1) -----> (1) Coords
                  |                    (1) Level
                  |
                  └-----> (M) Image
```

## Переменные окружения

Система использует переменные окружения для конфигурации:

| Переменная | Описание | По умолчанию |
|------------|----------|--------------|
| FSTR_DB_HOST | Хост базы данных PostgreSQL | localhost |
| FSTR_DB_PORT | Порт базы данных | 5432 |
| FSTR_DB_LOGIN | Логин для подключения к БД | fstr_user |
| FSTR_DB_PASS | Пароль для подключения к БД | fstr_password |
| FSTR_DB_NAME | Имя базы данных | fstr_db |
| SECRET_KEY | Секретный ключ Django | (авто-генерация) |
| DEBUG | Режим отладки | True |

### Настройка для продакшена

Для производственного развертывания рекомендуется:

1. Создать файл `.env` с реальными значениями
2. Установить `DEBUG=False`
3. Настроить `ALLOWED_HOSTS` в settings.py
4. Использовать надежные пароли для БД
5. Настроить SSL/TLS сертификаты

## Разработка и развертывание

### Структура проекта
```
стажировка/
├── fstr_api/           # Основные настройки Django
├── passes/             # Приложение для работы с перевалами
├── docker-compose.yml  # Конфигурация Docker
├── Dockerfile         # Образ приложения
├── requirements.txt   # Python зависимости
├── test_*.py         # Тестовые скрипты
└── README.md         # Документация
```

### Команды для разработчиков

**Создание миграций:**
```bash
python manage.py makemigrations
```

**Применение миграций:**
```bash
python manage.py migrate
```

**Создание суперпользователя:**
```bash
python manage.py createsuperuser
```

**Запуск в режиме разработки:**
```bash
python manage.py runserver
```

**Доступ к административной панели:**
- URL: http://localhost:8000/admin/
- Позволяет управлять всеми записями через веб-интерфейс

## Заключение

Данный проект представляет собой полнофункциональное REST API для системы регистрации горных перевалов, соответствующее всем требованиям технического задания. Реализованная система обеспечивает:

- Надежное хранение данных о перевалах
- Удобный API для мобильных приложений
- Систему модерации и статусов
- Защиту персональных данных пользователей
- Масштабируемую архитектуру

Проект готов к развертыванию и дальнейшему развитию функциональности.
